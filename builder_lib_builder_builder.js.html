<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>builder/lib/builder/builder.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AbstractAdapter.html">AbstractAdapter</a><ul class='methods'><li data-type='method'><a href="AbstractAdapter.html#_byPath">_byPath</a></li><li data-type='method'><a href="AbstractAdapter.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="AbstractAdapter.html#_write">_write</a></li><li data-type='method'><a href="AbstractAdapter.html#byGlob">byGlob</a></li><li data-type='method'><a href="AbstractAdapter.html#byPath">byPath</a></li><li data-type='method'><a href="AbstractAdapter.html#write">write</a></li></ul></li><li><a href="AbstractBuilder.html">AbstractBuilder</a><ul class='methods'><li data-type='method'><a href="AbstractBuilder.html#addTask">addTask</a></li><li data-type='method'><a href="AbstractBuilder.html#build">build</a></li></ul></li><li><a href="AbstractFormatter.html">AbstractFormatter</a></li><li><a href="AbstractReader.html">AbstractReader</a><ul class='methods'><li data-type='method'><a href="AbstractReader.html#_byGlob">_byGlob</a></li><li data-type='method'><a href="AbstractReader.html#_byPath">_byPath</a></li><li data-type='method'><a href="AbstractReader.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="AbstractReader.html#byGlob">byGlob</a></li><li data-type='method'><a href="AbstractReader.html#byPath">byPath</a></li></ul></li><li><a href="AbstractReaderWriter.html">AbstractReaderWriter</a><ul class='methods'><li data-type='method'><a href="AbstractReaderWriter.html#_byGlob">_byGlob</a></li><li data-type='method'><a href="AbstractReaderWriter.html#_byPath">_byPath</a></li><li data-type='method'><a href="AbstractReaderWriter.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="AbstractReaderWriter.html#_write">_write</a></li><li data-type='method'><a href="AbstractReaderWriter.html#byGlob">byGlob</a></li><li data-type='method'><a href="AbstractReaderWriter.html#byPath">byPath</a></li><li data-type='method'><a href="AbstractReaderWriter.html#write">write</a></li></ul></li><li><a href="DuplexCollection.html">DuplexCollection</a><ul class='methods'><li data-type='method'><a href="DuplexCollection.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="DuplexCollection.html#byGlob">byGlob</a></li><li data-type='method'><a href="DuplexCollection.html#byGlobSource">byGlobSource</a></li><li data-type='method'><a href="DuplexCollection.html#byPath">byPath</a></li><li data-type='method'><a href="DuplexCollection.html#write">write</a></li></ul></li><li><a href="FileSystem.html">FileSystem</a><ul class='methods'><li data-type='method'><a href="FileSystem.html#byGlob">byGlob</a></li><li data-type='method'><a href="FileSystem.html#byPath">byPath</a></li><li data-type='method'><a href="FileSystem.html#write">write</a></li></ul></li><li><a href="Memory.html">Memory</a><ul class='methods'><li data-type='method'><a href="Memory.html#byGlob">byGlob</a></li><li data-type='method'><a href="Memory.html#byPath">byPath</a></li><li data-type='method'><a href="Memory.html#write">write</a></li></ul></li><li><a href="ReaderCollection.html">ReaderCollection</a><ul class='methods'><li data-type='method'><a href="ReaderCollection.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="ReaderCollection.html#byGlob">byGlob</a></li><li data-type='method'><a href="ReaderCollection.html#byPath">byPath</a></li></ul></li><li><a href="ReaderCollectionPrioritized.html">ReaderCollectionPrioritized</a><ul class='methods'><li data-type='method'><a href="ReaderCollectionPrioritized.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="ReaderCollectionPrioritized.html#byGlob">byGlob</a></li><li data-type='method'><a href="ReaderCollectionPrioritized.html#byPath">byPath</a></li></ul></li><li><a href="Resource.html">Resource</a><ul class='methods'><li data-type='method'><a href="Resource.html#buffer">buffer</a></li><li data-type='method'><a href="Resource.html#clone">clone</a></li><li data-type='method'><a href="Resource.html#getBuffer">getBuffer</a></li><li data-type='method'><a href="Resource.html#getPath">getPath</a></li><li data-type='method'><a href="Resource.html#getPathTree">getPathTree</a></li><li data-type='method'><a href="Resource.html#getStatInfo">getStatInfo</a></li><li data-type='method'><a href="Resource.html#getStream">getStream</a></li><li data-type='method'><a href="Resource.html#getString">getString</a></li><li data-type='method'><a href="Resource.html#pushCollection">pushCollection</a></li><li data-type='method'><a href="Resource.html#setBuffer">setBuffer</a></li><li data-type='method'><a href="Resource.html#setPath">setPath</a></li><li data-type='method'><a href="Resource.html#setStream">setStream</a></li><li data-type='method'><a href="Resource.html#setString">setString</a></li></ul></li><li><a href="Trace.html">Trace</a></li></ul><h3>Modules</h3><ul><li><a href="module-builder_builder.html">builder/builder</a><ul class='methods'><li data-type='method'><a href="module-builder_builder.html#~build">build</a></li></ul></li><li><a href="module-builder_processors_bundlers_flexChangesBundler.html">builder/processors/bundlers/flexChangesBundler</a></li><li><a href="module-builder_processors_bundlers_manifestBundler.html">builder/processors/bundlers/manifestBundler</a></li><li><a href="module-builder_processors_bundlers_moduleBundler.html">builder/processors/bundlers/moduleBundler</a></li><li><a href="module-builder_processors_debugFileCreator.html">builder/processors/debugFileCreator</a></li><li><a href="module-builder_processors_resourceCopier.html">builder/processors/resourceCopier</a></li><li><a href="module-builder_processors_stringReplacer.html">builder/processors/stringReplacer</a></li><li><a href="module-builder_processors_themeBuilder.html">builder/processors/themeBuilder</a></li><li><a href="module-builder_processors_uglifier.html">builder/processors/uglifier</a></li><li><a href="module-builder_processors_versionInfoGenerator.html">builder/processors/versionInfoGenerator</a></li><li><a href="module-builder_tasks_buildThemes.html">builder/tasks/buildThemes</a></li><li><a href="module-builder_tasks_bundlers_generateBundle.html">builder/tasks/bundlers/generateBundle</a></li><li><a href="module-builder_tasks_bundlers_generateComponentPreload.html">builder/tasks/bundlers/generateComponentPreload</a></li><li><a href="module-builder_tasks_bundlers_generateFlexChangesBundle.html">builder/tasks/bundlers/generateFlexChangesBundle</a></li><li><a href="module-builder_tasks_bundlers_generateLibraryPreload.html">builder/tasks/bundlers/generateLibraryPreload</a></li><li><a href="module-builder_tasks_bundlers_generateManifestBundle.html">builder/tasks/bundlers/generateManifestBundle</a></li><li><a href="module-builder_tasks_bundlers_generateStandaloneAppBundle.html">builder/tasks/bundlers/generateStandaloneAppBundle</a></li><li><a href="module-builder_tasks_createDebugFiles.html">builder/tasks/createDebugFiles</a></li><li><a href="module-builder_tasks_generateVersionInfo.html">builder/tasks/generateVersionInfo</a></li><li><a href="module-builder_tasks_replaceCopyright.html">builder/tasks/replaceCopyright</a></li><li><a href="module-builder_tasks_replaceVersion.html">builder/tasks/replaceVersion</a></li><li><a href="module-builder_tasks_uglify.html">builder/tasks/uglify</a></li><li><a href="module-init_init.html">init/init</a></li><li><a href="module-normalizer_normalizer.html">normalizer/normalizer</a><ul class='methods'><li data-type='method'><a href="module-normalizer_normalizer.html#~generateDependencyTree">generateDependencyTree</a></li><li data-type='method'><a href="module-normalizer_normalizer.html#~generateProjectTree">generateProjectTree</a></li></ul></li><li><a href="module-normalizer_translators_npm.html">normalizer/translators/npm</a><ul class='methods'><li data-type='method'><a href="module-normalizer_translators_npm.html#.generateDependencyTree">generateDependencyTree</a></li></ul></li><li><a href="module-normalizer_translators_static.html">normalizer/translators/static</a><ul class='methods'><li data-type='method'><a href="module-normalizer_translators_static.html#.processTree">processTree</a></li><li data-type='method'><a href="module-normalizer_translators_static.html#~generateDependencyTree">generateDependencyTree</a></li></ul></li><li><a href="module-resources_fsInterface.html">resources/fsInterface</a></li><li><a href="module-resources_resourceFactory.html">resources/resourceFactory</a><ul class='methods'><li data-type='method'><a href="module-resources_resourceFactory.html#~createAdapter">createAdapter</a></li><li data-type='method'><a href="module-resources_resourceFactory.html#~createCollectionsForTree">createCollectionsForTree</a></li><li data-type='method'><a href="module-resources_resourceFactory.html#~createResource">createResource</a></li><li data-type='method'><a href="module-resources_resourceFactory.html#~createWorkspace">createWorkspace</a></li></ul></li><li><a href="module-server_middleware_discovery.html">server/middleware/discovery</a></li><li><a href="module-server_middleware_nonReadRequests.html">server/middleware/nonReadRequests</a></li><li><a href="module-server_middleware_serveResources.html">server/middleware/serveResources</a></li><li><a href="module-server_middleware_serveThemes.html">server/middleware/serveThemes</a></li><li><a href="module-server_middleware_versionInfo.html">server/middleware/versionInfo</a></li><li><a href="module-server_server.html">server/server</a></li><li><a href="module-server_sslUtil.html">server/sslUtil</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">builder/lib/builder/builder.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const log = require("@ui5/logger").getGroupLogger("builder:builder");
const resourceFactory = require("@ui5/fs").resourceFactory;
const typeRepository = require("../types/typeRepository");

const definedTasks = {
	replaceCopyright: require("../tasks/replaceCopyright"),
	replaceVersion: require("../tasks/replaceVersion"),
	createDebugFiles: require("../tasks/createDebugFiles"),
	uglify: require("../tasks/uglify"),
	buildThemes: require("../tasks/buildThemes"),
	generateVersionInfo: require("../tasks/generateVersionInfo"),
	generateManifestBundle: require("../tasks/bundlers/generateManifestBundle"),
	generateFlexChangesBundle: require("../tasks/bundlers/generateFlexChangesBundle"),
	generateComponentPreload: require("../tasks/bundlers/generateComponentPreload"),
	generateStandaloneAppBundle: require("../tasks/bundlers/generateStandaloneAppBundle"),
	generateBundle: require("../tasks/bundlers/generateBundle"),
	generateLibraryPreload: require("../tasks/bundlers/generateLibraryPreload")
};


// Set of tasks for development
const devTasks = [
	"replaceCopyright",
	"replaceVersion",
	"buildThemes"
];

/**
 * Calculates the elapsed build time and returns a prettified output
 *
 * @private
 * @param {Array} startTime Array provided by &lt;code>process.hrtime()&lt;/code>
 * @returns {string} Difference between now and the provided time array as formatted string
 */
function getElapsedTime(startTime) {
	const prettyHrtime = require("pretty-hrtime");
	const timeDiff = process.hrtime(startTime);
	return prettyHrtime(timeDiff);
}

/**
 * The UI5 Builder.
 *
 * @module builder/builder
 */

/**
 * Configures the project build and starts it.
 *
 * @param {Object} parameters Parameters
 * @param {Object} parameters.tree Dependency tree
 * @param {string} parameters.destPath Target path
 * @param {boolean} [parameters.buildDependencies=false] Decides whether project dependencies are built as well
 * @param {boolean} [parameters.dev=false] Decides whether a development build should be activated (skips non-essential and time-intensive tasks)
 * @param {boolean} [parameters.selfContained=false] Flag to activate self contained build
 * @param {Array} [parameters.includedTasks=[]] List of tasks to be included
 * @param {Array} [parameters.excludedTasks=[]] List of tasks to be excluced. If the wildcard '*' is provided, only the included tasks will be executed.
 * @param {Array} [parameters.devExcludeProject=[]] List of projects to be exlcuded from development build
 * @returns {Promise&lt;undefined>} Promise resolving to &lt;code>undefined&lt;/code> once build has finished
 */
function build({tree, destPath, buildDependencies = false, dev = false, selfContained = false, includedTasks = [], excludedTasks = [], devExcludeProject = []}) {
	const startTime = process.hrtime();
	log.info(`Building project ${tree.metadata.name}` + (buildDependencies ? "" : " not") +
		" including dependencies..." + (dev ? " [dev mode]" : ""));
	log.verbose(`Building to ${destPath}...`);

	let selectedTasks = composeTaskList({dev, selfContained, includedTasks, excludedTasks});

	const fsTarget = resourceFactory.createAdapter({
		fsBasePath: destPath,
		virBasePath: "/"
	});


	const projects = {}; // Unique project index to prevent building the same project multiple times

	const projectCountMarker = {};
	function projectCount(project, count = 0) {
		if (buildDependencies) {
			count = project.dependencies.reduce((depCount, depProject) => {
				return projectCount(depProject, depCount);
			}, count);
		}
		if (!projectCountMarker[project.metadata.name]) {
			count++;
			projectCountMarker[project.metadata.name] = true;
		}
		return count;
	}
	const iProjectCount = projectCount(tree);
	const buildLogger = log.createTaskLogger("ðŸ›  ", iProjectCount);

	function buildProject(project) {
		let depPromise;
		let projectTasks = selectedTasks;
		if (buildDependencies) {
			// Build dependencies in sequence as it is far easier to detect issues and reduces
			// side effects or other issues such as too many open files
			depPromise = project.dependencies.reduce(function(p, depProject) {
				return p.then(() => buildProject(depProject));
			}, Promise.resolve());
		} else {
			depPromise = Promise.resolve();
		}
		// Build the project after all dependencies have been built
		return depPromise.then(() => {
			if (projects[project.metadata.name]) {
				return Promise.resolve();
			} else {
				projects[project.metadata.name] = true;
			}
			buildLogger.startWork(`Building project ${project.metadata.name}`);

			const projectType = typeRepository.getType(project.type);
			const resourceCollections = resourceFactory.createCollectionsForTree(project, {
				useNamespaces: true
			});

			const workspace = resourceFactory.createWorkspace({
				reader: resourceCollections.source,
				name: project.metadata.name
			});

			if (dev &amp;&amp; devExcludeProject.indexOf(project.metadata.name) !== -1) {
				projectTasks = composeTaskList({dev: false, selfContained, includedTasks, excludedTasks});
			}
			return projectType.build({
				resourceCollections: {
					workspace,
					dependencies: resourceCollections.dependencies
				},
				tasks: projectTasks,
				project,
				parentLogger: log
			}).then(() => {
				log.verbose("Finished building project %s. Writing out files...", project.metadata.name);
				buildLogger.completeWork(1);

				return workspace.byGlob("/**/*.*").then((resources) => {
					return Promise.all(resources.map((resource) => {
						if (project === tree &amp;&amp; project.metadata.namespace) {
							// Root-project only: Remove namespace prefix if given
							resource.setPath(resource.getPath().replace(
								new RegExp(`^/resources/${project.metadata.namespace}`), ""));
						}
						return fsTarget.write(resource);
					}));
				});
			});
		});
	}

	return buildProject(tree).then(() => {
		log.info(`Build succeeded in ${getElapsedTime(startTime)}`);
	}, (err) => {
		log.error(`Build failed in ${getElapsedTime(startTime)}`);
		throw err;
	});
}
/**
 * Creates the list of tasks to be executed by the build process
 *
 * Sets specific tasks to be disabled by default, these tasks need to be included explicitly.
 * Based on the selected build mode (dev|selfContained|preload), different tasks are enabled.
 * Tasks can be enabled or disabled. The wildcard &lt;code>*&lt;/code> is also supported and affects all tasks.
 *
 * @private
 * @param {boolean} dev Sets development mode, which only runs essential tasks
 * @param {boolean} selfContained True if a the build should be self-contained or false for prelead build bundles
 * @param {Array} includedTasks Task list to be included from build
 * @param {Array} excludedTasks Task list to be exlcuded from build
 * @returns {Array} Return a task list for the builder
 */
function composeTaskList({dev, selfContained, includedTasks, excludedTasks}) {
	let selectedTasks = Object.keys(definedTasks).reduce((list, key) => {
		list[key] = true;
		return list;
	}, {});

	// Exclude tasks: manifestBundler
	selectedTasks.generateManifestBundle = false;
	selectedTasks.generateStandaloneAppBundle = false;

	if (selfContained) {
		// No preloads, bundle only
		selectedTasks.generateComponentPreload = false;
		selectedTasks.generateStandaloneAppBundle = true;
		selectedTasks.generateLibraryPreload = false;
	}

	// Only run essential tasks in development mode, it is not desired to run time consuming tasks during development.
	if (dev) {
		// Overwrite all other tasks with noop promise
		Object.keys(selectedTasks).forEach((key) => {
			if (devTasks.indexOf(key) === -1) {
				selectedTasks[key] = false;
			}
		});
	}

	// Exclude tasks
	for (let i = 0; i &lt; excludedTasks.length; i++) {
		let taskName = excludedTasks[i];
		if (taskName === "*") {
			Object.keys(selectedTasks).forEach((sKey) => {
				selectedTasks[sKey] = false;
			});
			break;
		}
		if (selectedTasks[taskName] !== false) {
			selectedTasks[taskName] = false;
		}
	}

	// Include tasks
	for (let i = 0; i &lt; includedTasks.length; i++) {
		let taskName = includedTasks[i];
		if (taskName === "*") {
			Object.keys(selectedTasks).forEach((sKey) => {
				selectedTasks[sKey] = true;
			});
			break;
		}
		if (selectedTasks[taskName] === false) {
			selectedTasks[taskName] = true;
		}
	}

	// Filter only for tasks that will be executed
	selectedTasks = Object.keys(selectedTasks).filter((task) => selectedTasks[task]);

	return selectedTasks;
}

module.exports = {
	build: build,
	tasks: definedTasks
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jul 06 2018 14:16:40 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
