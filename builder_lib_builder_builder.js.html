<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>builder/lib/builder/builder.js - UI5 Build and Development Tooling - API Reference</title>
    
    <meta name="description" content="UI5 Build and Development Tooling - API Reference" />
    
        <meta name="keywords" content="openui5 sapui5 ui5 build development tool api reference" />
        <meta name="keyword" content="openui5 sapui5 ui5 build development tool api reference" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/SAP/ui5-tooling" target="_blank" class="menu-item" id="github_link" >GitHub</a></h2><h3>Modules</h3><ul><li><a href="module-@ui5_builder.html">@ui5/builder</a></li><li><a href="module-@ui5_fs.html">@ui5/fs</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.html#.fsInterface">fsInterface</a></li></ul></li><li><a href="module-@ui5_project.html">@ui5/project</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-@ui5_builder.builder.html">@ui5/builder.builder</a><ul class='methods'><li data-type='method'><a href="module-@ui5_builder.builder.html#.build">build</a></li></ul></li><li><a href="module-@ui5_builder.processors.html">@ui5/builder.processors</a><ul class='methods'><li data-type='method'><a href="module-@ui5_builder.processors.html#.debugFileCreator">debugFileCreator</a></li><li data-type='method'><a href="module-@ui5_builder.processors.html#.flexChangesBundler">flexChangesBundler</a></li><li data-type='method'><a href="module-@ui5_builder.processors.html#.manifestBundler">manifestBundler</a></li><li data-type='method'><a href="module-@ui5_builder.processors.html#.moduleBundler">moduleBundler</a></li><li data-type='method'><a href="module-@ui5_builder.processors.html#.resourceCopier">resourceCopier</a></li><li data-type='method'><a href="module-@ui5_builder.processors.html#.stringReplacer">stringReplacer</a></li><li data-type='method'><a href="module-@ui5_builder.processors.html#.themeBuilder">themeBuilder</a></li><li data-type='method'><a href="module-@ui5_builder.processors.html#.uglifier">uglifier</a></li><li data-type='method'><a href="module-@ui5_builder.processors.html#.versionInfoGenerator">versionInfoGenerator</a></li></ul></li><li><a href="module-@ui5_builder.tasks.html">@ui5/builder.tasks</a><ul class='methods'><li data-type='method'><a href="module-@ui5_builder.tasks.html#.buildThemes">buildThemes</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.createDebugFiles">createDebugFiles</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.generateBundle">generateBundle</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.generateComponentPreload">generateComponentPreload</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.generateFlexChangesBundle">generateFlexChangesBundle</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.generateLibraryManifest">generateLibraryManifest</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.generateLibraryPreload">generateLibraryPreload</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.generateManifestBundle">generateManifestBundle</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.generateStandaloneAppBundle">generateStandaloneAppBundle</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.generateVersionInfo">generateVersionInfo</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.replaceCopyright">replaceCopyright</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.replaceVersion">replaceVersion</a></li><li data-type='method'><a href="module-@ui5_builder.tasks.html#.uglify">uglify</a></li></ul></li><li><a href="module-@ui5_fs.resourceFactory.html">@ui5/fs.resourceFactory</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.resourceFactory.html#.createAdapter">createAdapter</a></li><li data-type='method'><a href="module-@ui5_fs.resourceFactory.html#.createCollectionsForTree">createCollectionsForTree</a></li><li data-type='method'><a href="module-@ui5_fs.resourceFactory.html#.createResource">createResource</a></li><li data-type='method'><a href="module-@ui5_fs.resourceFactory.html#.createWorkspace">createWorkspace</a></li></ul></li><li><a href="module-@ui5_project.normalizer.html">@ui5/project.normalizer</a><ul class='methods'><li data-type='method'><a href="module-@ui5_project.normalizer.html#.generateDependencyTree">generateDependencyTree</a></li><li data-type='method'><a href="module-@ui5_project.normalizer.html#.generateProjectTree">generateProjectTree</a></li></ul></li><li><a href="module-@ui5_project.projectPreprocessor.html">@ui5/project.projectPreprocessor</a><ul class='methods'><li data-type='method'><a href="module-@ui5_project.projectPreprocessor.html#.processTree">processTree</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="module-@ui5_builder.processors.ThemeBuilder.html">@ui5/builder.processors.ThemeBuilder</a><ul class='methods'><li data-type='method'><a href="module-@ui5_builder.processors.ThemeBuilder.html#build">build</a></li><li data-type='method'><a href="module-@ui5_builder.processors.ThemeBuilder.html#clearCache">clearCache</a></li></ul></li><li><a href="module-@ui5_fs.AbstractReader.html">@ui5/fs.AbstractReader</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.AbstractReader.html#byGlob">byGlob</a></li><li data-type='method'><a href="module-@ui5_fs.AbstractReader.html#byPath">byPath</a></li></ul></li><li><a href="module-@ui5_fs.AbstractReaderWriter.html">@ui5/fs.AbstractReaderWriter</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.AbstractReaderWriter.html#byGlob">byGlob</a></li><li data-type='method'><a href="module-@ui5_fs.AbstractReaderWriter.html#byPath">byPath</a></li><li data-type='method'><a href="module-@ui5_fs.AbstractReaderWriter.html#write">write</a></li></ul></li><li><a href="module-@ui5_fs.adapters.AbstractAdapter.html">@ui5/fs.adapters.AbstractAdapter</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.adapters.AbstractAdapter.html#byGlob">byGlob</a></li><li data-type='method'><a href="module-@ui5_fs.adapters.AbstractAdapter.html#byPath">byPath</a></li><li data-type='method'><a href="module-@ui5_fs.adapters.AbstractAdapter.html#write">write</a></li></ul></li><li><a href="module-@ui5_fs.adapters.FileSystem.html">@ui5/fs.adapters.FileSystem</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.adapters.FileSystem.html#byGlob">byGlob</a></li><li data-type='method'><a href="module-@ui5_fs.adapters.FileSystem.html#byPath">byPath</a></li><li data-type='method'><a href="module-@ui5_fs.adapters.FileSystem.html#write">write</a></li></ul></li><li><a href="module-@ui5_fs.adapters.Memory.html">@ui5/fs.adapters.Memory</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.adapters.Memory.html#byGlob">byGlob</a></li><li data-type='method'><a href="module-@ui5_fs.adapters.Memory.html#byPath">byPath</a></li><li data-type='method'><a href="module-@ui5_fs.adapters.Memory.html#write">write</a></li></ul></li><li><a href="module-@ui5_fs.DuplexCollection.html">@ui5/fs.DuplexCollection</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.DuplexCollection.html#byGlob">byGlob</a></li><li data-type='method'><a href="module-@ui5_fs.DuplexCollection.html#byPath">byPath</a></li><li data-type='method'><a href="module-@ui5_fs.DuplexCollection.html#write">write</a></li></ul></li><li><a href="module-@ui5_fs.ReaderCollection.html">@ui5/fs.ReaderCollection</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.ReaderCollection.html#byGlob">byGlob</a></li><li data-type='method'><a href="module-@ui5_fs.ReaderCollection.html#byPath">byPath</a></li></ul></li><li><a href="module-@ui5_fs.ReaderCollectionPrioritized.html">@ui5/fs.ReaderCollectionPrioritized</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.ReaderCollectionPrioritized.html#byGlob">byGlob</a></li><li data-type='method'><a href="module-@ui5_fs.ReaderCollectionPrioritized.html#byPath">byPath</a></li></ul></li><li><a href="module-@ui5_fs.Resource.html">@ui5/fs.Resource</a><ul class='methods'><li data-type='method'><a href="module-@ui5_fs.Resource.html#clone">clone</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#getBuffer">getBuffer</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#getPath">getPath</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#getStatInfo">getStatInfo</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#getStream">getStream</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#getString">getString</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#setBuffer">setBuffer</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#setPath">setPath</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#setStream">setStream</a></li><li data-type='method'><a href="module-@ui5_fs.Resource.html#setString">setString</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">builder/lib/builder/builder.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const log = require("@ui5/logger").getGroupLogger("builder:builder");
const resourceFactory = require("@ui5/fs").resourceFactory;
const typeRepository = require("../types/typeRepository");
const taskRepository = require("../tasks/taskRepository");

const definedTasks = taskRepository.getAllTasks();

// Set of tasks for development
const devTasks = [
	"replaceCopyright",
	"replaceVersion",
	"buildThemes"
];

/**
 * Calculates the elapsed build time and returns a prettified output
 *
 * @private
 * @param {Array} startTime Array provided by &lt;code>process.hrtime()&lt;/code>
 * @returns {string} Difference between now and the provided time array as formatted string
 */
function getElapsedTime(startTime) {
	const prettyHrtime = require("pretty-hrtime");
	const timeDiff = process.hrtime(startTime);
	return prettyHrtime(timeDiff);
}

/**
 * Creates the list of tasks to be executed by the build process
 *
 * Sets specific tasks to be disabled by default, these tasks need to be included explicitly.
 * Based on the selected build mode (dev|selfContained|preload), different tasks are enabled.
 * Tasks can be enabled or disabled. The wildcard &lt;code>*&lt;/code> is also supported and affects all tasks.
 *
 * @private
 * @param {Object} parameters
 * @param {boolean} parameters.dev Sets development mode, which only runs essential tasks
 * @param {boolean} parameters.selfContained True if a the build should be self-contained or false for prelead build bundles
 * @param {Array} parameters.includedTasks Task list to be included from build
 * @param {Array} parameters.excludedTasks Task list to be excluded from build
 * @returns {Array} Return a task list for the builder
 */
function composeTaskList({dev, selfContained, includedTasks, excludedTasks}) {
	let selectedTasks = Object.keys(definedTasks).reduce((list, key) => {
		list[key] = true;
		return list;
	}, {});

	// Exclude tasks: manifestBundler
	selectedTasks.generateManifestBundle = false;
	selectedTasks.generateStandaloneAppBundle = false;
	selectedTasks.transformBootstrapHtml = false;

	if (selfContained) {
		// No preloads, bundle only
		selectedTasks.generateComponentPreload = false;
		selectedTasks.generateStandaloneAppBundle = true;
		selectedTasks.transformBootstrapHtml = true;
		selectedTasks.generateLibraryPreload = false;
	}

	// Only run essential tasks in development mode, it is not desired to run time consuming tasks during development.
	if (dev) {
		// Overwrite all other tasks with noop promise
		Object.keys(selectedTasks).forEach((key) => {
			if (devTasks.indexOf(key) === -1) {
				selectedTasks[key] = false;
			}
		});
	}

	// Exclude tasks
	for (let i = 0; i &lt; excludedTasks.length; i++) {
		const taskName = excludedTasks[i];
		if (taskName === "*") {
			Object.keys(selectedTasks).forEach((sKey) => {
				selectedTasks[sKey] = false;
			});
			break;
		}
		if (selectedTasks[taskName] !== false) {
			selectedTasks[taskName] = false;
		}
	}

	// Include tasks
	for (let i = 0; i &lt; includedTasks.length; i++) {
		const taskName = includedTasks[i];
		if (taskName === "*") {
			Object.keys(selectedTasks).forEach((sKey) => {
				selectedTasks[sKey] = true;
			});
			break;
		}
		if (selectedTasks[taskName] === false) {
			selectedTasks[taskName] = true;
		}
	}

	// Filter only for tasks that will be executed
	selectedTasks = Object.keys(selectedTasks).filter((task) => selectedTasks[task]);

	return selectedTasks;
}

/**
 * Builder
 *
 * @public
 * @namespace
 * @alias module:@ui5/builder.builder
 */
module.exports = {
	tasks: definedTasks,

	/**
	 * Configures the project build and starts it.
	 *
	 * @public
	 * @param {Object} parameters Parameters
	 * @param {Object} parameters.tree Dependency tree
	 * @param {string} parameters.destPath Target path
	 * @param {boolean} [parameters.buildDependencies=false] Decides whether project dependencies are built as well
	 * @param {boolean} [parameters.dev=false] Decides whether a development build should be activated (skips non-essential and time-intensive tasks)
	 * @param {boolean} [parameters.selfContained=false] Flag to activate self contained build
	 * @param {Array} [parameters.includedTasks=[]] List of tasks to be included
	 * @param {Array} [parameters.excludedTasks=[]] List of tasks to be excluded. If the wildcard '*' is provided, only the included tasks will be executed.
	 * @param {Array} [parameters.devExcludeProject=[]] List of projects to be excluded from development build
	 * @returns {Promise} Promise resolving to &lt;code>undefined&lt;/code> once build has finished
	 */
	build({
		tree, destPath,
		buildDependencies = false, dev = false, selfContained = false,
		includedTasks = [], excludedTasks = [], devExcludeProject = []
	}) {
		const startTime = process.hrtime();
		log.info(`Building project ${tree.metadata.name}` + (buildDependencies ? "" : " not") +
			" including dependencies..." + (dev ? " [dev mode]" : ""));
		log.verbose(`Building to ${destPath}...`);

		const selectedTasks = composeTaskList({dev, selfContained, includedTasks, excludedTasks});

		const fsTarget = resourceFactory.createAdapter({
			fsBasePath: destPath,
			virBasePath: "/"
		});


		const projects = {}; // Unique project index to prevent building the same project multiple times

		const projectCountMarker = {};
		function projectCount(project, count = 0) {
			if (buildDependencies) {
				count = project.dependencies.reduce((depCount, depProject) => {
					return projectCount(depProject, depCount);
				}, count);
			}
			if (!projectCountMarker[project.metadata.name]) {
				count++;
				projectCountMarker[project.metadata.name] = true;
			}
			return count;
		}
		const iProjectCount = projectCount(tree);
		const buildLogger = log.createTaskLogger("ðŸ›  ", iProjectCount);

		function buildProject(project) {
			let depPromise;
			let projectTasks = selectedTasks;
			if (buildDependencies) {
				// Build dependencies in sequence as it is far easier to detect issues and reduces
				// side effects or other issues such as too many open files
				depPromise = project.dependencies.reduce(function(p, depProject) {
					return p.then(() => buildProject(depProject));
				}, Promise.resolve());
			} else {
				depPromise = Promise.resolve();
			}
			// Build the project after all dependencies have been built
			return depPromise.then(() => {
				if (projects[project.metadata.name]) {
					return Promise.resolve();
				} else {
					projects[project.metadata.name] = true;
				}
				buildLogger.startWork(`Building project ${project.metadata.name}`);

				const projectType = typeRepository.getType(project.type);
				const resourceCollections = resourceFactory.createCollectionsForTree(project, {
					useNamespaces: true
				});

				const workspace = resourceFactory.createWorkspace({
					reader: resourceCollections.source,
					name: project.metadata.name
				});

				if (dev &amp;&amp; devExcludeProject.indexOf(project.metadata.name) !== -1) {
					projectTasks = composeTaskList({dev: false, selfContained, includedTasks, excludedTasks});
				}
				return projectType.build({
					resourceCollections: {
						workspace,
						dependencies: resourceCollections.dependencies
					},
					tasks: projectTasks,
					project,
					parentLogger: log
				}).then(() => {
					log.verbose("Finished building project %s. Writing out files...", project.metadata.name);
					buildLogger.completeWork(1);

					return workspace.byGlob("/**/*.*").then((resources) => {
						return Promise.all(resources.map((resource) => {
							if (project === tree &amp;&amp; project.metadata.namespace) {
								// Root-project only: Remove namespace prefix if given
								resource.setPath(resource.getPath().replace(
									new RegExp(`^/resources/${project.metadata.namespace}`), ""));
							}
							return fsTarget.write(resource);
						}));
					});
				});
			});
		}

		return buildProject(tree).then(() => {
			log.info(`Build succeeded in ${getElapsedTime(startTime)}`);
		}, (err) => {
			log.error(`Build failed in ${getElapsedTime(startTime)}`);
			throw err;
		});
	}
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Jan 10 2019 09:55:24 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>




</body>
</html>
